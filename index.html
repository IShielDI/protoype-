<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SpendWise - AI-Powered Personal Finance App (with Gemini Advisor)</title>
    <!-- Load Tailwind CSS from CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configure Tailwind to use Inter font and apply dark theme -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary': '#4f46e5', // Indigo 600
                        'accent': '#a855f7', // Fuchsia 500
                    }
                }
            }
        }
    </script>
    <style>
        /* Apply smooth transitions and global dark background */
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }
        /* Custom scrollbar for better look in dark mode */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563; /* gray-600 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* gray-500 */
        }
        /* Custom class for the pulse animation used in confirmation */
        @keyframes pulse-fade {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.05); }
        }
        .animate-pulse-fade {
            animation: pulse-fade 1.5s ease-in-out infinite;
        }
        /* Style for active navigation item */
        .nav-item-active {
            color: white;
            box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.5), 0 2px 4px -2px rgba(79, 70, 229, 0.5);
            background-color: rgba(79, 70, 229, 0.2);
        }
        .nav-item-inactive:hover {
            color: #818cf8; /* indigo-300 */
        }
        /* Custom keyframes for button loading state */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        /* Custom style for rendering markdown output (bold, spacing) */
        #advisor-output p {
            margin-bottom: 0.75rem;
        }
        #advisor-output strong {
            color: #e5e7eb; /* White/Light Gray */
        }
    </style>
</head>
<body class="bg-gray-900 min-h-screen text-gray-100 pb-20 sm:pb-0">

    <!-- Main Application Container -->
    <div id="app">
        <!-- Content will be rendered here by JavaScript -->
    </div>

    <!-- Icon Library (Lucide) - Used inline in JS -->
    <script>
        // Mapping of icon names to SVG content (Simplified for single file)
        const icons = {
            Home: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-home"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>',
            PlusSquare: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus-square"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M12 8v8"/><path d="M8 12h8"/></svg>',
            Wallet: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-wallet"><path d="M19 7V4a1 1 0 0 0-1-1H5a2 2 0 0 0 0 4h14a2 2 0 0 1 0 4H5a2 2 0 0 0 0 4h14v2"/><path d="M20 12h-2"/><path d="M4 20h16"/><path d="M5 21v-2"/></svg>',
            ShoppingBag: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-shopping-bag"><path d="M6 2L3 7v13a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V7l-3-5"/><path d="M3 7h18"/><path d="M16 10a4 4 0 0 1-8 0"/></svg>',
            Zap: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-zap"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>',
            User: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>',
            Bell: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bell"><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></svg>',
            Check: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check"><path d="M20 6 9 17l-5-5"/></svg>',
            TrendingUp: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trending-up"><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></svg>',
            Globe: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-globe"><circle cx="12" cy="12" r="10"/><path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20"/><path d="M2 12h20"/></svg>',
            DollarSign: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-dollar-sign"><line x1="12" x2="12" y1="2" y2="22"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>',
            X: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>',
            MapPin: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-map-pin"><path d="M12 12a2 2 0 1 0 0-4 2 2 0 0 0 0 4Z"/><path d="M19.07 13.93A10 10 0 1 0 12 21.68v-1.92"/></svg>',
            Loader: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-loader"><path d="M12 2v4"/><path d="m16.2 7.8 2.5-2.5"/><path d="M18 12h4"/><path d="m16.2 16.2 2.5 2.5"/><path d="M12 18v4"/><path d="m7.8 16.2-2.5 2.5"/><path d="M6 12H2"/><path d="m7.8 7.8-2.5-2.5"/></svg>',
        };

        // Utility to get a styled SVG icon
        const getIcon = (name, size = 20, className = '') => {
            const svgContent = icons[name] || '';
            // Replace default size in SVG content
            return svgContent.replace(/width="24"/g, `width="${size}"`).replace(/height="24"/g, `height="${size}"`).replace(/class="lucide [^"]*"/, `class="${className}"`);
        };
    </script>

    <script>
        // --- Gemini API Configuration (Mandatory) ---
        const apiKey = "";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;


        // --- Simulated Backend Data and Configuration ---
        const categoryColors = {
            // Updated structure to include a simple hex code for Canvas drawing
            Food: {
                tailwind: 'bg-red-500/50 text-red-300 ring-red-500/40',
                hex: '#ef4444' // red-500
            },
            Travel: {
                tailwind: 'bg-cyan-500/50 text-cyan-300 ring-cyan-500/40',
                hex: '#06b6d4' // cyan-500
            },
            Shopping: {
                tailwind: 'bg-fuchsia-500/50 text-fuchsia-300 ring-fuchsia-500/40',
                hex: '#d946ef' // fuchsia-500
            },
            Bills: {
                tailwind: 'bg-yellow-500/50 text-yellow-300 ring-yellow-500/40',
                hex: '#f59e0b' // yellow-500
            },
            Subscriptions: {
                tailwind: 'bg-indigo-500/50 text-indigo-300 ring-indigo-500/40',
                hex: '#6366f1' // indigo-500
            },
            Other: {
                tailwind: 'bg-gray-500/50 text-gray-300 ring-gray-500/40',
                hex: '#6b7280' // gray-500
            },
        };

        const initialFinancialData = {
            digitalBalance: 50000,
            cashBalance: 5000,
            totalExpenses: 25000,
            categoryExpenses: {
                Food: 8000,
                Travel: 5000,
                Shopping: 6000,
                Bills: 4000,
                Subscriptions: 2000,
                Other: 0
            },
            budgets: {
                Food: 10000,
                Shopping: 8000,
                Bills: 5000, // Budget to be checked against
            },
            goal: {
                name: 'Emergency Fund',
                target: 100000,
                current: 35000,
                projectedDate: 'Dec 2025',
            },
            transactions: [
                // Added a mock location to one transaction for demonstration
                { 
                    id: 10, 
                    date: 'Oct 28', 
                    amount: -2500, 
                    category: 'Subscriptions', 
                    notes: 'Software renewal fee', 
                    type: 'Card',
                    location: { lat: 12.9716, lng: 77.5946 } // Mock location: Bangalore, India
                },
                { id: 9, date: 'Oct 27', amount: -1500, category: 'Shopping', notes: 'New shirt and trousers', type: 'UPI' },
                { id: 8, date: 'Oct 26', amount: -1200, category: 'Food', notes: 'Monthly grocery shop', type: 'UPI' },
                { id: 7, date: 'Oct 25', amount: -500, category: 'Food', notes: 'Dinner at Pizzeria', type: 'Card' },
                { id: 6, date: 'Oct 24', amount: -2000, category: 'Shopping', notes: 'New headphones', type: 'UPI' },
                { id: 5, date: 'Oct 23', amount: 500, category: 'Cash', notes: 'ATM Withdrawal', type: 'Digital to Cash' },
                { id: 4, date: 'Oct 22', amount: -1500, category: 'Travel', notes: 'Weekend Train Ticket', type: 'Card' },
                { id: 3, date: 'Oct 21', amount: -1000, category: 'Bills', notes: 'Electricity bill', type: 'UPI' },
                { id: 2, date: 'Oct 20', amount: -3000, category: 'Bills', notes: 'Rent installment', type: 'Card' },
                { id: 1, date: 'Oct 19', amount: -800, category: 'Food', notes: 'Lunch with colleagues', type: 'Cash' },
            ]
        };

        const staticAiInsights = [
            { id: 1, type: 'alert', text: 'You might **overspend on dining** this week. Dining out trend is up 12%' },
            { id: 2, type: 'tip', text: 'Use grocery coupons this week to save **₹200**. Check Smart Shopping!' },
            { id: 3, type: 'goal', text: 'Reduce online shopping by 15% to reach your **savings goal faster**.' },
        ];

        const smartShoppingRecs = [
            { id: 1, name: 'Smart Watch X9', price: 8500, rating: 4.8, cashback: 500, badge: 'Best Value' },
            { id: 2, name: 'Noise-Cancelling Earbuds', price: 1500, rating: 4.5, cashback: 100, badge: 'Top Seller' },
            { id: 3, name: 'Ergonomic Desk Chair', price: 12000, rating: 4.7, cashback: 0, badge: 'Online Deal' },
        ];

        // --- Global State Management ---
        let appData = initialFinancialData;
        let currentView = 'dashboard';
        let transactionFilter = 'All';
        // Existing: State for transient location data during expense input
        let currentCapturedLocation = null; 
        
        // NEW: LLM Advisor State
        let advisorAnalysis = null; // Stores the generated markdown text
        let isAnalysisLoading = false; // Loading indicator for the API call

        const setView = (newView) => {
            currentView = newView;
            // Clear location state whenever switching away from or to the AddExpense screen
            if (newView !== 'addExpense') {
                 currentCapturedLocation = null;
            }
            renderApp();
        };

        const setTransactionFilter = (newFilter) => {
            transactionFilter = newFilter;
            renderApp();
        };

        // --- Utility Functions ---

        const formatCurrency = (amount) => `₹${Math.abs(amount).toLocaleString('en-IN')}`;
        
        const formatCoordinates = (lat, lng) => `${lat.toFixed(4)}, ${lng.toFixed(4)}`;

        const calculateCategoryList = (data) => {
            const total = data.totalExpenses;
            return Object.entries(data.categoryExpenses).map(([name, amount]) => ({
                name,
                amount,
                percentage: total > 0 ? (amount / total) * 100 : 0,
                color: categoryColors[name] ? categoryColors[name].tailwind : 'bg-gray-500', // Use tailwind class
                hexColor: categoryColors[name] ? categoryColors[name].hex : '#6b7280', // Use hex color
            }));
        };

        const getDynamicInsights = (data) => {
            const dynamicInsights = [];
            
            const billsBudget = data.budgets.Bills || 0;
            const billsSpent = data.categoryExpenses.Bills || 0;
            const budgetUtilization = billsSpent / billsBudget;

            if (billsBudget > 0 && budgetUtilization >= 0.90) { 
                 const percentOver = Math.round((budgetUtilization - 1) * 100);
                 const overText = budgetUtilization > 1 ? `You are **${percentOver}% over budget**!` : `You are **90% utilized** on your Bills budget.`;
                 
                 dynamicInsights.push({
                    id: 101, 
                    type: 'alert', 
                    text: `Budget Alert for **Bills**: ${overText}. Consider pausing discretionary spending.` 
                });
            }

            if (data.totalExpenses > 30000) {
                dynamicInsights.push({
                    id: 102, 
                    type: 'alert', 
                    text: `High Spending Month! Total expenses exceed **₹30,000**. Review your 'Shopping' category.` 
                });
            }

            return dynamicInsights;
        };
        // --- Chart Drawing Function (Existing Feature) ---

        const createPieChart = (categories, canvasId) => {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            const size = 300; 
            const centerX = size / 2;
            const centerY = size / 2;
            const radius = 100;
            let currentAngle = 0; 

            // Set high resolution for better visual quality
            canvas.width = size * 2;
            canvas.height = size * 2;
            ctx.scale(2, 2); 

            ctx.clearRect(0, 0, size, size);

            categories.forEach(category => {
                if (category.percentage > 0) {
                    const sliceAngle = (category.percentage / 100) * 2 * Math.PI;
                    const endAngle = currentAngle + sliceAngle;

                    ctx.beginPath();
                    ctx.fillStyle = category.hexColor;
                    ctx.moveTo(centerX, centerY);
                    ctx.arc(centerX, centerY, radius, currentAngle, endAngle);
                    ctx.closePath();
                    ctx.fill();

                    ctx.strokeStyle = '#1f2937'; // gray-800
                    ctx.lineWidth = 2;
                    ctx.stroke();

                    currentAngle = endAngle;
                }
            });

            // Draw a central hole (donut effect)
            ctx.beginPath();
            ctx.fillStyle = '#1f2937'; // gray-800 (matches card background)
            ctx.arc(centerX, centerY, 55, 0, 2 * Math.PI);
            ctx.fill();
            
            // Draw Center Text
            ctx.fillStyle = '#e5e7eb'; // light gray text
            ctx.font = 'bold 20px Inter';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('Total', centerX, centerY - 12);

            ctx.font = 'bold 16px Inter';
            ctx.fillStyle = '#94a3b8'; // slategray
            ctx.fillText(formatCurrency(appData.totalExpenses), centerX, centerY + 12);
        };


        // --- Data Mutators ---

        // Location Capture Handler (Existing Feature)
        const captureLocation = () => {
            const statusDiv = document.getElementById('location-status');
            if (!statusDiv) return;

            if (!navigator.geolocation) {
                statusDiv.innerHTML = `<span class="text-red-400">${getIcon('X', 18, 'mr-2')} Geolocation is not supported by your browser.</span>`;
                return;
            }

            // Show loading state
            statusDiv.innerHTML = `<span class="text-yellow-400 flex items-center">${getIcon('Loader', 18, 'mr-2 animate-spin')} Capturing location...</span>`;
            statusDiv.classList.remove('hidden');

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    currentCapturedLocation = { lat, lng };

                    // Display success
                    statusDiv.innerHTML = `<span class="text-green-400 flex items-center">${getIcon('Check', 18, 'mr-2')} Location captured: ${formatCoordinates(lat, lng)}</span>`;
                },
                (error) => {
                    currentCapturedLocation = null;
                    let errorMessage = "Location capture failed.";
                    if (error.code === error.PERMISSION_DENIED) {
                        errorMessage = "Access denied. Please allow location access to record it.";
                    } else if (error.code === error.TIMEOUT) {
                        errorMessage = "Location request timed out. Try again.";
                    }
                    // Display error
                    statusDiv.innerHTML = `<span class="text-red-400 flex items-center">${getIcon('X', 18, 'mr-2')} ${errorMessage}</span>`;
                },
                // Options for getCurrentPosition
                { enableHighAccuracy: false, timeout: 5000, maximumAge: 0 }
            );
        };


        const handleAddExpense = (amount, category, paymentType, notes) => {
            let newDigitalBalance = appData.digitalBalance;
            let newCashBalance = appData.cashBalance;

            // Update balances based on payment type
            if (paymentType === 'Cash') {
                newCashBalance -= amount;
            } else {
                newDigitalBalance -= amount;
            }

            // Update total expenses and category expenses
            const newCategoryExpenses = {
                ...appData.categoryExpenses,
                [category]: (appData.categoryExpenses[category] || 0) + amount,
            };

            const newTransaction = {
                id: Date.now(),
                date: 'Today',
                amount: -amount,
                category,
                notes: notes || 'Manual entry',
                type: paymentType,
                // NEW: Include captured location
                location: currentCapturedLocation
            };

            appData = {
                ...appData,
                digitalBalance: newDigitalBalance,
                cashBalance: newCashBalance,
                totalExpenses: appData.totalExpenses + amount,
                categoryExpenses: newCategoryExpenses,
                transactions: [newTransaction, ...appData.transactions],
            };
            
            // Reset transient location state after successful save
            currentCapturedLocation = null;

            // Show confirmation toast
            showToast('Expense added successfully!', 'green');

            // Re-render only if we are still on the dashboard or relevant screen
            if (currentView === 'dashboard' || currentView === 'addExpense') renderApp();
        };

        const handleCashTransaction = (amount, type) => {
            let newDigitalBalance = appData.digitalBalance;
            let newCashBalance = appData.cashBalance;
            let notes = '';
            let transactionType = '';

            if (type === 'add') { // Digital to Cash (Withdrawal from digital)
                if (newDigitalBalance < amount) {
                    showToast('Insufficient digital balance!', 'red');
                    return;
                }
                newDigitalBalance -= amount;
                newCashBalance += amount;
                notes = 'ATM/Digital Withdrawal';
                transactionType = 'Digital to Cash';
            } else { // Cash to Digital (Deposit to digital)
                if (newCashBalance < amount) {
                    showToast('Insufficient cash balance!', 'red');
                    return;
                    
                }
                newDigitalBalance += amount;
                newCashBalance -= amount;
                notes = 'Cash Deposit/Transfer';
                transactionType = 'Cash to Digital';
            }

            const newTransaction = {
                id: Date.now(),
                date: 'Today',
                amount: (type === 'add' ? amount : -amount),
                category: 'Cash',
                notes: notes,
                type: transactionType,
            };

            appData = {
                ...appData,
                digitalBalance: newDigitalBalance,
                cashBalance: newCashBalance,
                transactions: [newTransaction, ...appData.transactions],
            };

            showToast(`${type === 'add' ? 'Cash added' : 'Cash withdrawn'} successfully!`, 'green');
            renderApp(); // Re-render to update Wallet screen
        };

        const handleShoppingPurchase = (amount) => {
            // Simulate purchase logic by calling addExpense
            handleAddExpense(amount, 'Shopping', 'Card', 'Smart Shopping Purchase');
            setView('dashboard');
        };

        // --- Gemini LLM Advisor Functions ---

        /**
         * Creates a detailed text prompt based on the current financial data.
         */
        const generateAdvisorPrompt = (data) => {
            // Calculate a simplified income estimate for context
            const totalIncome = data.digitalBalance + data.cashBalance + data.totalExpenses; 
            
            // Generate spending status relative to budget
            const categoryStatus = Object.entries(data.categoryExpenses).map(([name, spent]) => {
                const budget = data.budgets[name];
                if (budget) {
                    const status = spent > budget 
                        ? `(OVER BUDGET by ${formatCurrency(spent - budget)})` 
                        : `(Under budget, ${formatCurrency(budget - spent)} remaining)`;
                    return `- ${name}: Spent ${formatCurrency(spent)} / Budget ${formatCurrency(budget)} ${status}`;
                }
                return `- ${name}: Spent ${formatCurrency(spent)}`;
            }).join('\n');

            const goalStatus = `- Savings Goal: ${data.goal.name}\n- Target: ${formatCurrency(data.goal.target)}\n- Current Progress: ${formatCurrency(data.goal.current)}\n- Projected Completion: ${data.goal.projectedDate}`;

            return `
                Analyze the following personal finance data and provide a concise, actionable report:

                --- Financial Snapshot ---
                Total Available Balance: ${formatCurrency(data.digitalBalance + data.cashBalance)}
                Total Income (Simulated Monthly): ${formatCurrency(totalIncome)}
                Total Expenses (This Period): ${formatCurrency(data.totalExpenses)}
                
                --- Spending Breakdown ---
                ${categoryStatus}

                --- Savings Goal ---
                ${goalStatus}

                --- Analysis Request ---
                1. Summarize the user's overall financial health and current trajectory (1 sentence).
                2. Identify the single most critical area for spending reduction based on the data and provide one specific, actionable strategy for that area.
                3. Give one piece of positive encouragement regarding their savings goal.

                Format your response using Markdown, with bold titles for each section.
            `;
        };
        
        /**
         * Calls the Gemini API with the financial data prompt using exponential backoff.
         */
        const callGeminiAdvisor = async () => {
            if (isAnalysisLoading) return;

            isAnalysisLoading = true;
            advisorAnalysis = null;
            renderApp(); // Update UI to show loading state

            const userQuery = generateAdvisorPrompt(appData);
            const systemPrompt = "You are SpendWise AI Advisor, a helpful, objective, and empathetic financial coach. Your response must be formatted as a single, easy-to-read block of text using standard Markdown for styling (e.g., **Title** for headings). Only output the analysis content.";
            const maxRetries = 3;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        // Throw error to trigger retry if HTTP status is bad
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

                    if (text) {
                        advisorAnalysis = text;
                        break; // Success, exit loop
                    } else {
                        throw new Error("Gemini response lacked text content.");
                    }

                } catch (error) {
                    console.error(`Attempt ${attempt + 1} failed:`, error);
                    if (attempt === maxRetries - 1) {
                        // Last attempt failed
                        advisorAnalysis = `<p class="text-red-400 text-center">❌ **Error:** Failed to connect to the Financial Advisor after several retries. Please try again later.</p>`;
                    } else {
                        // Wait with exponential backoff before retrying
                        const delay = Math.pow(2, attempt) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
            }

            isAnalysisLoading = false;
            renderApp(); // Update UI to show result or final error
        };


        // --- Toast/Modal Functionality (No alert/confirm) ---

        const showToast = (message, color) => {
            const toastContainer = document.getElementById('toast-container');
            if (!toastContainer) return;

            const toast = document.createElement('div');
            const colorClass = color === 'green' ? 'bg-green-600' : 'bg-red-600';
            const icon = color === 'green' ? getIcon('Check', 20, 'mr-2') : getIcon('X', 20, 'mr-2');

            toast.className = `fixed bottom-20 left-1/2 -translate-x-1/2 p-3 ${colorClass} text-white rounded-lg flex items-center shadow-lg transition-opacity duration-300 z-50`;
            toast.innerHTML = `${icon} ${message}`;

            toastContainer.appendChild(toast);

            setTimeout(() => {
                toast.classList.add('opacity-0');
                setTimeout(() => toast.remove(), 300);
            }, 2500);
        };

        // --- Reusable HTML Components (Templating) ---

        const Card = (content, className = '') => `
            <div class="bg-gray-800 rounded-xl p-5 shadow-xl transition-all duration-300 ${className}">
                ${content}
            </div>
        `;

        const TotalDisplay = (label, amount, iconName, color = 'text-cyan-400') => `
            ${Card(`
                <div class="flex flex-col items-start space-y-2 border-gray-700/50">
                    <div class="p-1 rounded-md bg-gray-700/50 ${color} w-fit">
                        ${getIcon(iconName, 24, '')}
                    </div>
                    <span class="text-sm font-medium text-gray-400">${label}</span>
                    <span class="text-3xl sm:text-4xl font-extrabold ${color}">
                        ${formatCurrency(amount)}
                    </span>
                </div>
            `, 'border border-gray-700/50')}
        `;

        const CategoryBar = (name, amount, totalExpenses, colorClass, hexColor) => {
            const percentage = totalExpenses > 0 ? (amount / totalExpenses) * 100 : 0;
            const percentageRounded = percentage.toFixed(1);

            const barColorClasses = colorClass.split(' ').slice(0, 2).join(' ').replace(/\/50/g, '');

            return Card(`
                <div class="flex justify-between items-end mb-2">
                    <span class="font-semibold text-gray-200 flex items-center">
                         <span class="inline-block w-2.5 h-2.5 rounded-full mr-2" style="background-color: ${hexColor}"></span>
                         ${name}
                    </span>
                    <span class="text-lg font-bold text-gray-300 flex items-baseline">
                        ${formatCurrency(amount)}
                        <span class="ml-2 text-xs font-medium text-gray-500">(${percentageRounded}%)</span>
                    </span>
                </div>
                <div class="w-full bg-gray-700 rounded-full h-2.5">
                    <div
                        class="h-2.5 rounded-full ${barColorClasses} transition-all duration-500"
                        style="width: ${percentage}%"
                    ></div>
                </div>
            `, 'p-3 cursor-pointer hover:ring-2 hover:ring-indigo-500/50 transition duration-150');
        };
        
        // Reusable component for displaying a single transaction row
        const TransactionRow = (t) => {
            const isExpense = t.amount < 0;
            const isTransfer = t.category === 'Cash' && t.type.includes('to');
            const sign = isExpense ? '-' : (isTransfer ? '' : '+'); 
            const colorClass = isExpense ? 'text-red-400' : (isTransfer ? 'text-yellow-400' : 'text-green-400');
            
            const categoryKey = t.category in categoryColors ? t.category : 'Other'; 
            const baseColorClass = categoryColors[categoryKey] ? categoryColors[categoryKey].tailwind.split('/')[0] : 'bg-gray-600';

            const locationDisplay = t.location ? `
                <div class="text-xs text-gray-500 mt-1 flex items-center">
                    ${getIcon('MapPin', 12, 'text-indigo-400 mr-1')}
                    ${formatCoordinates(t.location.lat, t.location.lng)}
                </div>
            ` : '';

            return `
                <div class="flex items-center justify-between p-3 border-b border-gray-700/50 hover:bg-gray-800/50 transition duration-150">
                    <!-- Icon & Details -->
                    <div class="flex items-start space-x-3 min-w-0">
                        <div class="p-2 rounded-full ring-1 ring-gray-600 ${baseColorClass} flex-shrink-0 text-white">
                            ${getIcon('DollarSign', 16, '')}
                        </div>
                        <div class="flex flex-col min-w-0">
                            <p class="text-sm font-medium text-white truncate">${t.notes || t.category}</p>
                            <p class="text-xs text-gray-400">
                                ${t.category} • ${t.type}
                            </p>
                            ${locationDisplay}
                        </div>
                    </div>
                    <!-- Date & Amount -->
                    <div class="text-right flex-shrink-0">
                        <p class="text-sm font-bold ${colorClass}">${sign}${formatCurrency(t.amount)}</p>
                        <p class="text-xs text-gray-500">${t.date}</p>
                    </div>
                </div>
            `;
        };

        // --- Screen Rendering Functions ---

        const renderDashboardScreen = () => {
            const data = appData;
            const categoryList = calculateCategoryList(data);
            const goalProgress = (data.goal.current / data.goal.target) * 100;
            
            const allInsights = [...staticAiInsights, ...getDynamicInsights(data)];

            let categoriesHtml = categoryList.map(cat =>
                CategoryBar(cat.name, cat.amount, data.totalExpenses, cat.color, cat.hexColor)
            ).join('');

            let insightsHtml = allInsights.map(insight => {
                const color = insight.type === 'alert' ? 'red' : 'indigo';
                const ring = insight.type === 'alert' ? 'ring-red-600/30' : 'ring-indigo-600/30';
                const textClass = insight.type === 'alert' ? 'text-red-200' : 'text-gray-200';
                const iconClass = insight.type === 'alert' ? 'text-red-400' : 'text-indigo-400';
                const formattedText = insight.text.replace(/\*\*(.*?)\*\*/g, '<span class="font-extrabold text-white">$1</span>');

                return Card(`
                    <div class="flex items-start">
                        ${getIcon('Zap', 20, `mt-0.5 mr-3 ${iconClass}`)}
                        <p class="text-sm ${textClass}">${formattedText}</p>
                    </div>
                `, `p-4 border-2 border-${color}-600 ${ring}`);
            }).join('');
            
            const filteredTransactions = data.transactions.filter(t => 
                transactionFilter === 'All' || t.category === transactionFilter
            );

            const filterOptions = ['All', ...Object.keys(categoryColors)].map(cat => 
                `<option value="${cat}" ${cat === transactionFilter ? 'selected' : ''}>${cat}</option>`
            ).join('');

            const allTransactionsHtml = filteredTransactions.length > 0
                ? filteredTransactions.map(TransactionRow).join('')
                : '<p class="text-center text-gray-500 py-4">No transactions recorded for this filter.</p>';

            return `
                <main class="p-4 sm:p-6 pb-24 max-w-4xl mx-auto">
                    <h2 class="text-2xl font-bold text-white mb-6">SpendWise Dashboard</h2>

                    <!-- 1. Total Balance and Expenses -->
                    <div class="grid grid-cols-2 gap-4 mb-8">
                        ${TotalDisplay("Total Balance (Digital + Cash)", data.digitalBalance + data.cashBalance, 'Globe', 'text-cyan-400')}
                        ${TotalDisplay("Total Expenses This Month", data.totalExpenses, 'TrendingUp', 'text-fuchsia-400')}
                    </div>

                    <!-- 2. Expense Categories Section (With Chart) -->
                    <h3 class="text-xl font-semibold text-white mb-4 border-b border-gray-700 pb-2">Category Breakdown</h3>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8 items-center">
                        <!-- Pie Chart Column -->
                        <div class="flex justify-center lg:justify-start">
                            <div class="w-full max-w-xs aspect-square">
                                <!-- Canvas for the Pie Chart -->
                                <canvas id="category-pie-chart" class="w-full h-full"></canvas>
                            </div>
                        </div>

                        <!-- Category List Column -->
                        <div class="space-y-3">
                            ${categoriesHtml}
                        </div>
                    </div>

                    <!-- 3. AI Insights Section -->
                    <h3 class="text-xl font-semibold text-white mb-4 border-b border-gray-700 pb-2 flex items-center">
                        ${getIcon('Zap', 20, 'text-yellow-400 mr-2')} AI Insights & Alerts
                    </h3>
                    <div class="space-y-4 mb-8">
                        ${insightsHtml}
                    </div>

                    <!-- 4. Goal Tracker -->
                    <h3 class="text-xl font-semibold text-white mb-4 border-b border-gray-700 pb-2">Goal Tracker</h3>
                    ${Card(`
                        <div class="p-4 border border-gray-700/50">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-lg font-bold text-white">${data.goal.name}</span>
                                <span class="text-sm font-medium text-cyan-400">Target: ${formatCurrency(data.goal.target)}</span>
                            </div>
                            <div class="w-full bg-gray-700 rounded-full h-4">
                                <div
                                    class="h-4 rounded-full bg-cyan-500 transition-all duration-700"
                                    style="width: ${goalProgress}%"
                                ></div>
                            </div>
                            <div class="flex justify-between items-center mt-2 text-sm text-gray-400">
                                <span>Progress: ${formatCurrency(data.goal.current)}</span>
                                <span>Projected: ${data.goal.projectedDate}</span>
                            </div>
                        </div>
                    `)}
                    
                    <!-- 5. Filterable Transactions List -->
                    <h3 class="text-xl font-semibold text-white mt-8 mb-4 border-b border-gray-700 pb-2">
                        Transactions
                    </h3>
                    
                    <!-- Filter Control -->
                    <div class="mb-4">
                        <label for="transaction-filter" class="block text-sm font-medium text-gray-300 mb-1">Filter by Category:</label>
                        <select
                            id="transaction-filter"
                            class="w-full sm:w-1/2 p-3 rounded-lg bg-gray-700 border border-gray-600 text-white focus:ring-indigo-500 focus:border-indigo-500"
                            onchange="setTransactionFilter(this.value)"
                        >
                            ${filterOptions}
                        </select>
                    </div>

                    ${Card(`
                        <div class="divide-y divide-gray-700/50 -mx-5">
                            ${allTransactionsHtml}
                        </div>
                    `, 'p-0')}
                </main>
            `;
        };

        const renderAddExpenseScreen = () => {
            const categories = Object.keys(categoryColors);
            const categoriesOptions = categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');

            let locationStatusContent = '';
            if (currentCapturedLocation) {
                 locationStatusContent = `<span class="text-green-400 flex items-center">${getIcon('Check', 18, 'mr-2')} Location captured: ${formatCoordinates(currentCapturedLocation.lat, currentCapturedLocation.lng)}</span>`;
            } else {
                 locationStatusContent = `<span class="text-gray-400 flex items-center">${getIcon('MapPin', 18, 'mr-2')} No location recorded for this expense.</span>`;
            }

            return `
                <main class="p-4 sm:p-6 pb-24 max-w-md mx-auto">
                    <h2 class="text-3xl font-bold text-white mb-6">Record New Expense</h2>
                    ${Card(`
                        <form id="add-expense-form" class="space-y-5">
                            <!-- Error Message Container -->
                            <div id="form-error-message" class="hidden p-3 bg-red-600/30 text-red-300 rounded-lg text-sm flex items-center">
                                ${getIcon('X', 20, 'mr-2')}
                                <span id="error-text"></span>
                            </div>
                            
                            <div>
                                <label for="expense-amount" class="block text-sm font-medium text-gray-300 mb-1">Amount (₹)</label>
                                <input
                                    type="number"
                                    id="expense-amount"
                                    required
                                    min="0.01"
                                    step="0.01"
                                    placeholder="e.g., 500.00"
                                    class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-white placeholder-gray-500 focus:ring-indigo-500 focus:border-indigo-500 text-2xl font-bold"
                                />
                            </div>

                            <div>
                                <label for="expense-category" class="block text-sm font-medium text-gray-300 mb-1">Category</label>
                                <select
                                    id="expense-category"
                                    required
                                    class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-white focus:ring-indigo-500 focus:border-indigo-500"
                                >
                                    ${categoriesOptions}
                                </select>
                            </div>

                            <div>
                                <label for="expense-payment-type" class="block text-sm font-medium text-gray-300 mb-1">Payment Type</label>
                                <select
                                    id="expense-payment-type"
                                    required
                                    class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-white focus:ring-indigo-500 focus:border-indigo-500"
                                >
                                    <option value="Card">Card</option>
                                    <option value="UPI">UPI (Digital)</option>
                                    <option value="Cash">Cash</option>
                                </select>
                            </div>
                            
                            <!-- Location Tracking Section (Existing Feature) -->
                            <div class="space-y-2">
                                <h4 class="text-sm font-medium text-gray-300">Location Tracking</h4>
                                <div id="location-status" class="p-2 text-sm rounded-lg bg-gray-700/50">
                                    ${locationStatusContent}
                                </div>
                                <button type="button" id="capture-location-button" class="w-full py-2 text-sm rounded-xl font-bold transition-all duration-300 active:scale-[0.98] bg-indigo-600/20 hover:bg-indigo-600/40 text-indigo-300 flex items-center justify-center">
                                    ${getIcon('MapPin', 18, 'mr-2')}
                                    Capture Current Location
                                </button>
                            </div>

                            <div>
                                <label for="expense-notes" class="block text-sm font-medium text-gray-300 mb-1">Notes (Optional)</label>
                                <input
                                    type="text"
                                    id="expense-notes"
                                    placeholder="What was this for?"
                                    class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-white placeholder-gray-500 focus:ring-indigo-500 focus:border-indigo-500"
                                />
                            </div>

                            <div class="flex space-x-3">
                                <button type="button" id="undo-button" class="flex-1 w-full py-3 rounded-xl font-bold transition-all duration-300 active:scale-[0.98] bg-red-600/50 hover:bg-red-600/70 shadow-none text-white">
                                    Clear Form
                                </button>
                                <button type="submit" class="flex-1 w-full py-3 rounded-xl font-bold transition-all duration-300 active:scale-[0.98] shadow-lg bg-indigo-600 hover:bg-indigo-500 text-white shadow-indigo-600/50">
                                    Submit Expense
                                </button>
                            </div>
                        </form>
                    `)}
                </main>
            `;
        };

        const renderSmartWalletScreen = () => {
            const data = appData;
            const cashTransactions = data.transactions.filter(t => t.type === 'Cash' || t.type.includes('Cash'));
            const isAlertActive = true; 

            const transactionsHtml = cashTransactions.length > 0
                ? cashTransactions.map(TransactionRow).join('')
                : '<p class="text-center text-gray-500 py-4">No recent cash movements.</p>';

            const alertHtml = isAlertActive ? Card(`
                <div class="flex justify-between items-start">
                    <div>
                        <span class="text-lg font-bold text-yellow-400 flex items-center">
                            ${getIcon('Bell', 20, 'text-yellow-400 mr-2')} Security Alert
                        </span>
                        <p class="text-sm text-gray-300 mt-1">Wallet possibly lost or stolen – enable tracking?</p>
                    </div>
                    <div class="flex flex-col space-y-2">
                        <button class="text-xs text-red-400 font-semibold hover:text-red-300" onclick="console.log('Alert Dismissed')">
                            Dismiss
                        </button>
                        <button class="text-xs text-indigo-400 font-semibold hover:text-indigo-300" onclick="console.log('Tracking Enabled!')">
                            Enable Tracking
                        </button>
                    </div>
                </div>
            `, 'mb-8 p-4 border-2 border-yellow-600 ring-4 ring-yellow-600/30') : '';


            return `
                <main class="p-4 sm:p-6 pb-24 max-w-4xl mx-auto">
                    <h2 class="text-3xl font-bold text-white mb-6">Smart Wallet</h2>

                    <!-- Cash Balance Display -->
                    ${Card(`
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="text-xl font-bold text-white">Current Cash Balance</h3>
                            ${getIcon('Wallet', 28, 'text-green-400')}
                        </div>
                        <p class="text-5xl font-extrabold text-green-400">
                            ${formatCurrency(data.cashBalance)}
                        </p>
                        <p class="text-sm text-gray-400 mt-2">Physical cash tracked by SpendWise</p>
                    `, 'mb-6 border-2 border-green-600 ring-4 ring-green-600/30')}

                    <!-- Add / Withdraw Controls (Improved UX) -->
                    ${Card(`
                        <h3 class="text-xl font-semibold text-white">Manage Cash</h3>
                        <div id="cash-management-error" class="hidden p-3 bg-red-600/30 text-red-300 rounded-lg text-sm flex items-center mb-4">
                            ${getIcon('X', 20, 'mr-2')}
                            <span id="cash-error-text"></span>
                        </div>
                        <input
                            type="number"
                            id="cash-amount"
                            min="0.01"
                            step="0.01"
                            placeholder="Amount (₹)"
                            class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-white placeholder-gray-500 focus:ring-indigo-500 focus:border-indigo-500"
                        />
                        <div class="flex space-x-4 mt-4">
                            <button id="add-cash-button" class="flex-1 w-full py-3 rounded-xl font-bold transition-all duration-300 active:scale-[0.98] shadow-lg bg-indigo-600 hover:bg-indigo-500 text-white shadow-indigo-600/50">
                                + Add Cash
                            </button>
                            <button id="withdraw-cash-button" class="flex-1 w-full py-3 rounded-xl font-bold transition-all duration-300 active:scale-[0.98] bg-red-600/50 hover:bg-red-600/70 shadow-none text-white">
                                - Withdraw Cash
                            </button>
                        </div>
                    `, 'mb-8 space-y-4')}

                    <!-- Lost/Theft Alert -->
                    ${alertHtml}

                    <!-- Recent Transactions -->
                    <h3 class="text-xl font-semibold text-white mb-4 border-b border-gray-700 pb-2">Recent Cash Transactions</h3>
                    <div class="space-y-2 divide-y divide-gray-700/50">
                        ${transactionsHtml}
                    </div>
                </main>
            `;
        };

        const renderSmartShoppingScreen = () => {
            const isSearching = false; 
            const searchRecs = smartShoppingRecs; 

            const recsHtml = searchRecs.length > 0 ? searchRecs.map(item => `
                ${Card(`
                    <div class="flex justify-between items-center p-4 border border-fuchsia-600/50">
                        <div class="space-y-1">
                            <div class="flex items-center space-x-2">
                                <span class="text-lg font-bold text-white">${item.name}</span>
                                <span class="text-xs font-semibold px-2 py-0.5 rounded-full bg-fuchsia-600/30 text-fuchsia-300 ring-1 ring-fuchsia-500">
                                    ${item.badge}
                                </span>
                            </div>
                            <p class="text-sm text-gray-300">Seller Rating: ${item.rating}/5</p>
                            ${item.cashback > 0 ? `
                                <p class="text-xs text-green-400 font-semibold">
                                    Cashback offer: ${formatCurrency(item.cashback)}
                                </p>
                            ` : ''}
                        </div>
                        <div class="text-right">
                            <p class="text-2xl font-extrabold text-cyan-400 mb-2">
                                ${formatCurrency(item.price)}
                            </p>
                            <button data-price="${item.price}" class="select-deal-button w-32 py-2 text-sm rounded-xl font-bold transition-all duration-300 active:scale-[0.98] shadow-lg bg-fuchsia-600 hover:bg-fuchsia-500 text-white shadow-fuchsia-600/50">
                                Select Best Deal
                            </button>
                        </div>
                    </div>
                `)}
            `).join('') : '<p class="text-center text-gray-500 py-10">No recommendations found. Try searching above!</p>';

            return `
                <main class="p-4 sm:p-6 pb-24 max-w-4xl mx-auto">
                    <h2 class="text-3xl font-bold text-white mb-6">Smart Shopping</h2>

                    <!-- Search Bar -->
                    ${Card(`
                        <div class="flex space-x-3">
                            <input
                                type="text"
                                id="shopping-search"
                                placeholder="Search products (e.g., Bluetooth Earbuds)"
                                class="flex-1 p-3 rounded-lg bg-gray-700 border border-gray-600 text-white placeholder-gray-500 focus:ring-fuchsia-500 focus:border-fuchsia-500"
                            />
                            <button id="shopping-search-button" class="w-24 py-3 rounded-xl font-bold transition-all duration-300 active:scale-[0.98] bg-fuchsia-600 hover:bg-fuchsia-500 text-white shadow-fuchsia-600/50">
                                Search
                            </button>
                        </div>
                    `, 'mb-6 border border-gray-700/50')}

                    <!-- AI Recommendations List -->
                    <h3 class="text-xl font-semibold text-white mb-4 border-b border-gray-700 pb-2 flex items-center">
                        ${getIcon('ShoppingBag', 20, 'text-fuchsia-400 mr-2')} AI Best Deals
                    </h3>

                    <div id="shopping-recs" class="space-y-4">
                        ${isSearching ? '<p class="text-center text-gray-500 py-10">Searching for deals...</p>' : recsHtml}
                    </div>
                </main>
            `;
        };
        
        // Helper function for rendering the Advisor section states
        const renderInitialAdvisorState = () => `
            <div class="text-center py-4">
                <p class="text-gray-400 mb-3">Tap the button below to generate a detailed, personalized financial report based on your current spending data and goals.</p>
                <p class="text-sm font-semibold text-indigo-400 flex items-center justify-center">
                    <span class="w-2 h-2 rounded-full bg-indigo-400 mr-2 animate-pulse"></span>
                    Powered by Gemini AI.
                </p>
            </div>
        `;

        const renderLoadingState = () => `
            <div class="text-center py-8 flex flex-col items-center">
                ${getIcon('Loader', 32, 'text-accent animate-spin')}
                <p class="mt-4 text-white font-semibold">Analyzing your data...</p>
                <p class="text-sm text-gray-400">This may take a few moments.</p>
            </div>
        `;
        
        const renderInsightsScreen = () => {
            const weeklySpending = [2000, 3500, 4200, 5000, 4800]; // Simulated spending for 5 weeks
            const maxSpending = Math.max(...weeklySpending);

            const spendingTrendHtml = weeklySpending.map((spend, index) => {
                const width = (spend / maxSpending) * 100;
                const isHighSpend = index === 3;
                return `
                    <div>
                        <div class="flex justify-between text-sm text-gray-400 mb-1">
                            <span>Week ${index + 1}</span>
                            <span class="${isHighSpend ? 'text-red-400 font-bold' : 'text-gray-300'}">
                                ${formatCurrency(spend)}
                            </span>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-3">
                            <div
                                class="h-3 rounded-full ${isHighSpend ? 'bg-red-500' : 'bg-indigo-500'} transition-all duration-700"
                                style="width: ${width}%"
                            ></div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Determine content for the advisor output area
            let advisorContent = '';
            if (isAnalysisLoading) {
                advisorContent = renderLoadingState();
            } else if (advisorAnalysis) {
                // Simple markdown rendering for the output
                const formattedAnalysis = advisorAnalysis
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // Bold text
                    .replace(/^- /gm, '<p class="pl-4 text-gray-300">') // Replace bullet list
                    .replace(/\n\n/g, '</p><p class="text-gray-300">') // Replace double newline with paragraph tag
                    .replace(/\n/g, '<br>'); // Handle single newlines

                advisorContent = `<div class="p-4 text-gray-300 text-sm leading-relaxed">${formattedAnalysis}</div>`;
            } else {
                advisorContent = renderInitialAdvisorState();
            }


            return `
                <main class="p-4 sm:p-6 pb-24 max-w-4xl mx-auto">
                    <h2 class="text-3xl font-bold text-white mb-6">Insights & Behavioral Analysis</h2>

                    <!-- LLM Advisor Section -->
                    <h3 class="text-xl font-semibold text-white mt-8 mb-4 border-b border-gray-700 pb-2 flex items-center">
                        Personalized Budget Advisor ✨
                    </h3>
                    
                    ${Card(`
                        <div id="advisor-output" class="min-h-[150px] flex flex-col justify-center items-center">
                            ${advisorContent}
                        </div>
                        
                        <button id="run-advisor-button" class="mt-4 w-full py-3 rounded-xl font-bold transition-all duration-300 active:scale-[0.98] shadow-lg ${isAnalysisLoading ? 'bg-gray-700 cursor-not-allowed text-gray-400' : 'bg-accent hover:bg-fuchsia-500 shadow-fuchsia-600/50 text-white'}" ${isAnalysisLoading ? 'disabled' : ''}>
                            ${isAnalysisLoading ? getIcon('Loader', 20, 'mr-2 animate-spin') : `${getIcon('Zap', 20, 'mr-2')} Get Personalized Budget Analysis ✨`}
                        </button>
                    `, 'mb-8')}

                    <!-- Spending Personality -->
                    <h3 class="text-xl font-semibold text-white mb-4 border-b border-gray-700 pb-2 flex items-center">
                        ${getIcon('Zap', 20, 'text-indigo-400 mr-2')} Spending Personality (Simulated)
                    </h3>
                    ${Card(`
                        <p class="text-4xl font-extrabold text-indigo-400 mb-2">Impulsive Spender</p>
                        <p class="text-gray-300">
                            Your current pattern suggests high, immediate spending in non-essential categories (Shopping, Dining) without long-term planning. You are prone to impulse buys when sales or discounts are offered.
                        </p>
                        <ul class="mt-4 text-sm text-gray-400 list-disc list-inside">
                            <li>Key Trait: 24% of purchases are unplanned.</li>
                            <li>Risk: Goal completion is delayed by 3 months.</li>
                        </ul>
                    `, 'mb-8 border border-gray-700/50')}

                    <!-- Behavioral Tips -->
                    <h3 class="text-xl font-semibold text-white mb-4 border-b border-gray-700 pb-2">Behavioral Tips</h3>
                    <div class="space-y-4 mb-8">
                        ${Card(`
                            <p class="text-sm font-bold text-cyan-400 mb-1">High Spending Alert</p>
                            <p class="text-gray-200">
                                You spent <span class="font-bold text-white">20% more on dining</span> this month compared to your 3-month average. Reallocate ${formatCurrency(1500)} from your discretionary budget.
                            </p>
                        `, 'p-4 border border-cyan-600/50')}
                        ${Card(`
                            <p class="text-sm font-bold text-cyan-400 mb-1">Actionable Savings</p>
                            <p class="text-gray-200">
                                Consider <span class="font-bold text-white">meal prepping</span> for two days a week to reduce dining spending by an estimated ${formatCurrency(1200)}/month.
                            </p>
                        `, 'p-4 border border-cyan-600/50')}
                        ${Card(`
                            <p class="text-sm font-bold text-cyan-400 mb-1">Financial Health</p>
                            <p class="text-gray-200">
                                Set reminders for recurring bills to <span class="font-bold text-white">avoid late fees</span>. Your average late payment is 3 days after the due date.
                            </p>
                        `, 'p-4 border border-cyan-600/50')}
                    </div>

                    <!-- Weekly Spending Trend Graph Simulation -->
                    <h3 class="text-xl font-semibold text-white mb-4 border-b border-gray-700 pb-2">Weekly Spending Trend</h3>
                    ${Card(`
                        <div class="p-6">
                            <div class="space-y-5">
                                ${spendingTrendHtml}
                            </div>
                        </div>
                    `)}
                </main>
            `;
        };

        const renderProfileScreen = () => {
            const data = appData;

            const totalBalance = data.digitalBalance + data.cashBalance;
            const totalExpenses = data.totalExpenses;

            const toggleHtml = (label, id, defaultState) => `
                <div class="flex justify-between items-center">
                    <span class="text-gray-200">${label}</span>
                    <button
                        id="${id}"
                        data-state="${defaultState}"
                        class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors ${defaultState ? 'bg-indigo-600' : 'bg-gray-600'}"
                    >
                        <span
                            class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${defaultState ? 'translate-x-6' : 'translate-x-1'}"
                        />
                    </button>
                </div>
            `;

            return `
                <main class="p-4 sm:p-6 pb-24 max-w-2xl mx-auto">
                    <h2 class="text-3xl font-bold text-white mb-6">Profile & Settings</h2>

                    <!-- Profile Header -->
                    ${Card(`
                        <div class="flex items-center space-x-4 border border-gray-700/50">
                            <div class="h-16 w-16 bg-indigo-600 rounded-full flex items-center justify-center text-3xl font-bold text-white">
                                SW
                            </div>
                            <div>
                                <p class="text-xl font-bold text-white">SpendWise User</p>
                                <p class="text-sm text-gray-400">user@spendwise.app</p>
                            </div>
                        </div>
                    `, 'mb-6')}

                    <!-- Financial Summary -->
                    <h3 class="text-xl font-semibold text-white mb-4 border-b border-gray-700 pb-2">Financial Summary</h3>
                    ${Card(`
                        <div class="grid grid-cols-2 gap-4 text-sm text-gray-300 border border-gray-700/50">
                            <div><p class="font-medium text-gray-400">Total Balance:</p><p class="text-cyan-400 font-bold">${formatCurrency(totalBalance)}</p></div>
                            <div><p class="font-medium text-gray-400">Total Expenses:</p><p class="text-fuchsia-400 font-bold">${formatCurrency(totalExpenses)}</p></div>
                        </div>
                    `, 'mb-6')}

                    <!-- Manage Linked Accounts (Simulated) -->
                    <h3 class="text-xl font-semibold text-white mb-4 border-b border-gray-700 pb-2">Manage Linked Accounts</h3>
                    ${Card(`
                        <div class="space-y-3 border border-gray-700/50">
                            <div class="flex justify-between items-center text-gray-200">
                                <span>ICICI Bank (**** 1234)</span>
                                <button onclick="console.log('Simulated: Unlinked')" class="w-20 py-1 text-xs rounded-xl font-bold bg-red-600/50 hover:bg-red-600/70 shadow-none text-white transition-colors duration-200">Unlink</button>
                            </div>
                            <div class="flex justify-between items-center text-gray-200">
                                <span>Google Pay UPI</span>
                                <button onclick="console.log('Simulated: Unlinked')" class="w-20 py-1 text-xs rounded-xl font-bold bg-red-600/50 hover:bg-red-600/70 shadow-none text-white transition-colors duration-200">Unlink</button>
                            </div>
                            <div class="text-center pt-2">
                                <button class="text-indigo-400 hover:text-indigo-300 text-sm font-medium transition-colors duration-200">+ Link New Account</button>
                            </div>
                        </div>
                    `, 'mb-6')}

                    <!-- Preferences -->
                    <h3 class="text-xl font-semibold text-white mb-4 border-b border-gray-700 pb-2">Preferences</h3>
                    ${Card(`
                        <div class="space-y-3">
                            ${toggleHtml('Push Notifications', 'toggle-push', true)}
                            ${toggleHtml('AI Tip Frequency', 'toggle-ai', true)}
                            ${toggleHtml('Dark Mode (Fixed)', 'toggle-dark', true)}
                        </div>
                    `)}

                    <!-- Logout / Delete -->
                    <div class="mt-8 space-y-3">
                        <button onclick="console.log('Simulated Logout')" class="w-full py-3 rounded-xl font-bold transition-all duration-300 active:scale-[0.98] shadow-lg bg-indigo-600 hover:bg-indigo-500 text-white shadow-indigo-600/50">
                            Logout
                        </button>
                        <button onclick="console.log('Simulated Account Deletion')" class="w-full py-3 rounded-xl font-bold transition-all duration-300 active:scale-[0.98] bg-red-600 hover:bg-red-500 text-white shadow-red-600/50">
                            Delete Account
                        </button>
                    </div>
                </main>
            `;
        };


        // --- Main Rendering and Event Setup ---

        const renderScreen = () => {
            switch (currentView) {
                case 'addExpense':
                    return renderAddExpenseScreen();
                case 'wallet':
                    return renderSmartWalletScreen();
                case 'shopping':
                    return renderSmartShoppingScreen();
                case 'insights':
                    return renderInsightsScreen();
                case 'profile':
                    return renderProfileScreen();
                case 'dashboard':
                default:
                    return renderDashboardScreen();
            }
        };

        const createNavItem = (id, label, iconName, alerts = false) => {
            const isActive = currentView === id;
            return `
                <button
                    data-view="${id}"
                    class="nav-item flex flex-col items-center p-1 rounded-xl transition-all duration-300 relative ${isActive ? 'nav-item-active' : 'nav-item-inactive text-gray-400'}"
                >
                    ${getIcon(iconName, 22, 'sm:w-5 sm:h-5')}
                    <!-- Reduced font size on mobile for better fit -->
                    <span class="text-[10px] sm:text-xs font-semibold mt-0.5">${label}</span>
                    ${alerts ? '<div class="absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full animate-pulse-fade"></div>' : ''}
                </button>
            `;
        };

        const renderApp = () => {
            const app = document.getElementById('app');

            // --- 1. Header HTML ---
            const headerHtml = `
                <header class="py-4 px-6 border-b border-gray-700/70 bg-gray-900 sticky top-0 z-10 shadow-lg">
                    <div class="flex justify-between items-center max-w-7xl mx-auto">
                        <h1 class="text-2xl font-extrabold text-white">
                            <span class="text-indigo-400">Spend</span>Wise
                        </h1>
                        <button aria-label="Notifications" class="p-2 rounded-full transition-colors duration-200 hover:bg-gray-700 active:scale-95 text-yellow-400 hover:bg-gray-700/50">
                            ${getIcon('Bell', 20, '')}
                        </button>
                    </div>
                </header>
            `;

            // --- 2. Main Content HTML ---
            const mainContentHtml = renderScreen();

            // --- 3. Navigation HTML ---
            const navHtml = `
                <nav class="fixed bottom-0 left-0 right-0 bg-gray-900 border-t border-gray-700/70 shadow-2xl z-20">
                    <!-- Adjusted padding and removed w-full from buttons for better mobile spacing -->
                    <div class="flex justify-around px-2 py-2 max-w-xl mx-auto">
                        ${createNavItem('dashboard', 'Dashboard', 'Home')}
                        ${createNavItem('addExpense', 'Add Expense', 'PlusSquare')}
                        ${createNavItem('wallet', 'Wallet', 'Wallet', true)}
                        ${createNavItem('shopping', 'Shopping', 'ShoppingBag')}
                        ${createNavItem('insights', 'Insights', 'Zap')}
                        ${createNavItem('profile', 'Profile', 'User')}
                    </div>
                </nav>
            `;

            // --- Full App Structure ---
            app.innerHTML = `
                ${headerHtml}
                ${mainContentHtml}
                ${navHtml}
                <div id="toast-container"></div>
            `;

            // --- Attach Event Listeners ---
            attachEventListeners();
        };

        const attachEventListeners = () => {
            // 1. Navigation Listeners
            document.querySelectorAll('.nav-item').forEach(button => {
                button.onclick = () => {
                    setView(button.getAttribute('data-view'));
                };
            });

            // 2. Screen-Specific Listeners (only run if the screen is visible)
            if (currentView === 'dashboard') {
                // Call the chart creation function after the dashboard content is in the DOM
                const categoryList = calculateCategoryList(appData);
                createPieChart(categoryList, 'category-pie-chart');
            }
            
            if (currentView === 'addExpense') {
                const form = document.getElementById('add-expense-form');
                const errorDiv = document.getElementById('form-error-message');
                const errorText = document.getElementById('error-text');
                const captureButton = document.getElementById('capture-location-button');

                const validateForm = (amount) => {
                    if (isNaN(amount) || amount <= 0) {
                        errorText.textContent = "Please enter a valid amount greater than zero.";
                        errorDiv.classList.remove('hidden');
                        return false;
                    }
                    errorDiv.classList.add('hidden');
                    return true;
                };

                if (captureButton) {
                    captureButton.onclick = captureLocation;
                }

                if (form) {
                    form.onsubmit = (e) => {
                        e.preventDefault();
                        const amount = parseFloat(document.getElementById('expense-amount').value);
                        const category = document.getElementById('expense-category').value;
                        const paymentType = document.getElementById('expense-payment-type').value;
                        const notes = document.getElementById('expense-notes').value;

                        if (validateForm(amount)) {
                            handleAddExpense(amount, category, paymentType, notes);
                            // Clear form fields
                            form.reset();
                            document.getElementById('expense-category').value = 'Food'; 
                            document.getElementById('expense-payment-type').value = 'Card';
                            
                            // Re-render to update the location status display
                            renderApp(); 
                        }
                    };
                }

                const undoButton = document.getElementById('undo-button');
                if (undoButton) {
                    undoButton.onclick = () => {
                        form.reset();
                        currentCapturedLocation = null; // Clear captured location on form clear
                        document.getElementById('expense-category').value = 'Food';
                        document.getElementById('expense-payment-type').value = 'Card';
                        errorDiv.classList.add('hidden'); 
                        showToast('Form cleared (simulated undo).', 'red');
                        renderApp(); // Re-render to clear location status
                    };
                }
            } else if (currentView === 'wallet') {
                const amountInput = document.getElementById('cash-amount');
                const addButton = document.getElementById('add-cash-button');
                const withdrawButton = document.getElementById('withdraw-cash-button');
                const errorDiv = document.getElementById('cash-management-error');
                const errorText = document.getElementById('cash-error-text');

                const validateCashForm = (amount) => {
                    if (isNaN(amount) || amount <= 0) {
                        errorText.textContent = "Please enter a valid amount greater than zero.";
                        errorDiv.classList.remove('hidden');
                        return false;
                    }
                    errorDiv.classList.add('hidden');
                    return true;
                };

                if (addButton) {
                    addButton.onclick = () => {
                        const amount = parseFloat(amountInput.value);
                        if (validateCashForm(amount)) handleCashTransaction(amount, 'add');
                        amountInput.value = '';
                    };
                }

                if (withdrawButton) {
                    withdrawButton.onclick = () => {
                        const amount = parseFloat(amountInput.value);
                        if (validateCashForm(amount)) handleCashTransaction(amount, 'withdraw');
                        amountInput.value = '';
                    };
                }
            } else if (currentView === 'shopping') {
                // Event listener for dealing with mock purchases
                document.querySelectorAll('.select-deal-button').forEach(button => {
                    button.onclick = () => {
                        const price = parseFloat(button.getAttribute('data-price'));
                        if (price > 0) {
                            handleShoppingPurchase(price);
                        }
                    };
                });
            } else if (currentView === 'insights') {
                const advisorButton = document.getElementById('run-advisor-button');
                if (advisorButton) {
                    advisorButton.onclick = callGeminiAdvisor;
                }
            } else if (currentView === 'profile') {
                // Event listeners for toggle switches (simulated)
                document.querySelectorAll('[id^="toggle-"]').forEach(toggle => {
                    toggle.onclick = () => {
                        let currentState = toggle.getAttribute('data-state') === 'true';
                        currentState = !currentState;
                        toggle.setAttribute('data-state', currentState.toString());

                        const knob = toggle.querySelector('span');
                        if (currentState) {
                            toggle.classList.remove('bg-gray-600');
                            toggle.classList.add('bg-indigo-600');
                            knob.classList.remove('translate-x-1');
                            knob.classList.add('translate-x-6');
                        } else {
                            toggle.classList.remove('bg-indigo-600');
                            toggle.classList.add('bg-gray-600');
                            knob.classList.remove('translate-x-6');
                            knob.classList.add('translate-x-1');
                        }
                        console.log(`${toggle.id} set to ${currentState}`);
                    };
                });
            }
        };

        // Initialize the application when the window loads
        window.onload = renderApp;
    </script>
</body>
</html>
